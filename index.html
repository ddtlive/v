<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iOS Resumable Player</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --ios-bg: #000; --ios-accent: #34C759; /* Ø£Ø®Ø¶Ø± Ù„Ù„Ù†Ø¬Ø§Ø­ */ }
        body { font-family: -apple-system, sans-serif; background: var(--ios-bg); color: white; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; }
        .glass-card { background: rgba(28, 28, 30, 0.9); backdrop-filter: blur(20px); border-radius: 20px; padding: 20px; border: 0.5px solid rgba(255,255,255,0.1); margin-top: 20px; }
        video { width: 100%; border-radius: 20px; background: #1c1c1e; }
        .progress-container { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin: 15px 0; overflow: hidden; display: block; }
        #pBar { width: 0%; height: 100%; background: #0A84FF; transition: width 0.3s; }
        input { width: 100%; padding: 14px; border-radius: 12px; border: none; background: rgba(255,255,255,0.1); color: white; margin-bottom: 15px; text-align: center; font-size: 16px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 14px; border-radius: 12px; border: none; font-weight: 600; }
        .btn-main { background: #0A84FF; color: white; }
        .btn-del { background: rgba(255, 59, 48, 0.2); color: #FF3B30; }
        #status { font-size: 13px; margin-bottom: 10px; color: #8e8e93; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div id="status">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <video id="video" controls playsinline></video>
    
    <div class="progress-container">
        <div id="pBar"></div>
    </div>

    <div class="glass-card">
        <input type="text" id="urlInput" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù‡Ù†Ø§">
        <div class="btn-group">
            <button class="btn-main" onclick="updateDB()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn-del" onclick="clearDB()">Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø©</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAjTD-OJBUYewp5bqV0iVh4Rxp5zjBsU54",
        databaseURL: "https://videos-5e336-default-rtdb.firebaseio.com",
    };
    firebase.initializeApp(firebaseConfig);
    const videoRef = firebase.database().ref('currentVideo');

    const video = document.getElementById('video');
    const pBar = document.getElementById('pBar');
    const status = document.getElementById('status');
    let downloadSession = null;

    videoRef.on('value', async (snapshot) => {
        const url = snapshot.val();
        if (url) {
            startResumableDownload(url);
        } else {
            status.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø·";
        }
    });

    async function startResumableDownload(url) {
        status.innerText = "ğŸ” ÙØ­Øµ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…Ø­Ù…Ù„Ø©...";
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„Ù€ Cache Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¬Ø²Ø§Ø¡ Ø³Ø§Ø¨Ù‚Ø©
        const cache = await caches.open('video-resumable-cache');
        const cachedResponse = await cache.match(url);

        if (cachedResponse) {
            const blob = await cachedResponse.blob();
            video.src = URL.createObjectURL(blob);
            pBar.style.width = '100%';
            status.innerText = "âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©";
            return;
        }

        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙƒØªÙ…Ù„Ø§Ù‹ØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Browser Cache Control)
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Safari ÙŠØ¯Ø¹Ù… Ø§Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¯Ø¹Ù… Range Requests
        fetchVideoWithProgress(url, cache);
    }

    function fetchVideoWithProgress(url, cache) {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.responseType = 'blob';

        // ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ£Ø¬Ø²Ø§Ø¡ ÙÙŠ Ø¢ÙŠÙÙˆÙ†
        xhr.setRequestHeader('Cache-Control', 'public, max-age=31536000');

        xhr.onprogress = (e) => {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                pBar.style.width = percent + '%';
                status.innerText = `Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${percent}%`;
            }
        };

        xhr.onload = function() {
            if (this.status === 200) {
                const blob = this.response;
                cache.put(url, new Response(blob)); // Ø­ÙØ¸Ù‡ ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                video.src = URL.createObjectURL(blob);
                status.innerText = "âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ­ÙÙØ¸";
            }
        };

        xhr.send();
    }

    function updateDB() {
        const val = document.getElementById('urlInput').value.trim();
        if(val) videoRef.set(val);
    }

    async function clearDB() {
        if(confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù…Ù„ ÙƒÙ„ÙŠØ§Ù‹ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
            videoRef.set("");
            await caches.delete('video-resumable-cache');
            location.reload();
        }
    }
</script>
</body>
</html>
