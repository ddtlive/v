<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ù…ØªØ²Ø§Ù…Ù† - Ø´Ø§Ù…Ù„</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        :root { --primary: #007AFF; --bg: #000000; --card: #1C1C1E; --accent: #32D74B; --danger: #FF3B30; }
        body { 
            font-family: -apple-system, sans-serif; 
            background: var(--bg); color: white; margin: 0; padding: 0;
            display: flex; flex-direction: column; min-height: 100vh; overflow-y: auto;
        }
        .header { padding: 15px; text-align: center; background: var(--card); border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
        .content { padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .video-container {
            position: relative; width: 100%; background: #000; border-radius: 15px; overflow: hidden;
            aspect-ratio: 16 / 9; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        video { width: 100%; height: 100%; object-fit: contain; }
        .voice-chat-card { border-right: 4px solid var(--accent); background: var(--card); display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-radius: 12px; }
        .controls-card { background: var(--card); padding: 15px; border-radius: 15px; display: flex; flex-direction: column; gap: 12px; }
        input { background: #2C2C2E; border: 1px solid #3d3d3d; padding: 12px; border-radius: 10px; color: white; font-size: 16px; outline: none; }
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .status-bar { font-size: 13px; color: var(--accent); text-align: center; padding: 10px; background: rgba(50, 215, 75, 0.1); border-radius: 8px; }
        .viewer-badge { background: var(--danger); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; align-self: center; }
    </style>
</head>
<body>

<div class="header"><h3 style="margin:0;">Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ù…ØªØ²Ø§Ù…Ù† ğŸ¬</h3></div>

<div class="content">
    <div class="viewer-badge">â— Ù…Ø¨Ø§Ø´Ø±: <span id="viewerCount">0</span></div>

    <div class="video-container">
        <video id="livePlayer" controls playsinline muted autoplay></video>
    </div>

    <div class="voice-chat-card">
        <div>
            <div style="font-weight: bold;">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ØµÙˆØªÙŠØ© ğŸ™ï¸</div>
            <div id="micStatus" style="font-size: 11px; color: #888;">Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ØºÙ„Ù‚</div>
        </div>
        <button id="micBtn" onclick="toggleMic()">ÙØªØ­ Ø§Ù„Ù…Ø§ÙŠÙƒ</button>
    </div>

    <div id="syncStatus" class="status-bar">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</div>

    <div class="controls-card" id="loginPanel">
        <input type="password" id="passInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„ØªØ­ÙƒÙ…...">
        <button onclick="checkPassword()">Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„</button>
    </div>

    <div id="adminPanel" class="controls-card" style="display: none;">
        <input type="url" id="urlInput" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø« (M3U8/MP4)...">
        <button onclick="updateGlobalVideo()">ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ù…ÙŠØ¹</button>
    </div>
</div>

<div id="audioGroup" style="display:none;"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAjTD-OJBUYewp5bqV0iVh4Rxp5zjBsU54",
        authDomain: "videos-5e336.firebaseapp.com",
        databaseURL: "https://videos-5e336-default-rtdb.firebaseio.com",
        projectId: "videos-5e336",
        appId: "1:300218651134:web:4bd24df8e555e62828f0af"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('live_sync');
    const viewersRef = firebase.database().ref('viewers_presence');

    const player = document.getElementById('livePlayer');
    const statusDiv = document.getElementById('syncStatus');
    let hls = null;
    let isAdmin = false;
    let isRemoteUpdate = false;
    let lastTimestamp = 0; // Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ ÙˆÙ‚Øª Ù‚Ø¯ÙŠÙ…

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª (PeerJS) ---
    const peer = new Peer();
    let myStream = null;
    let isMicOn = false;

    peer.on('open', (id) => {
        const myPresence = viewersRef.push({ peerId: id });
        myPresence.onDisconnect().remove();
    });

    peer.on('call', (call) => {
        call.answer(null);
        call.on('stream', (stream) => {
            const audio = document.createElement('audio');
            audio.srcObject = stream;
            audio.autoplay = true;
            document.getElementById('audioGroup').appendChild(audio);
        });
    });

    async function toggleMic() {
        const btn = document.getElementById('micBtn');
        if (!isMicOn) {
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isMicOn = true;
                btn.innerText = "Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø§ÙŠÙƒ";
                btn.style.background = "var(--danger)";
                viewersRef.once('value', (s) => {
                    s.forEach((c) => {
                        const d = c.val();
                        if (d.peerId && d.peerId !== peer.id) peer.call(d.peerId, myStream);
                    });
                });
            } catch (e) { alert("Ø§ÙØªØ­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†"); }
        } else {
            if (myStream) myStream.getTracks().forEach(t => t.stop());
            isMicOn = false;
            btn.innerText = "ÙØªØ­ Ø§Ù„Ù…Ø§ÙŠÙƒ";
            btn.style.background = "var(--primary)";
        }
    }

    // --- Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ---
    function loadVideo(url) {
        if (!url) return;
        if (Hls.isSupported() && url.includes('m3u8')) {
            if (hls) hls.destroy();
            hls = new Hls({ enableWorker: true });
            hls.loadSource(url);
            hls.attachMedia(player);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                player.play().catch(() => {});
            });
        } else {
            player.src = url;
            player.play().catch(() => {});
        }
    }

    function checkPassword() {
        if(document.getElementById('passInput').value === "1234") {
            isAdmin = true;
            document.getElementById('loginPanel').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'flex';
        }
    }

    function updateGlobalVideo() {
        const url = document.getElementById('urlInput').value;
        if(url && isAdmin) {
            db.set({ url: url, status: "play", time: 0, timestamp: Date.now() });
        }
    }

    // --- Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø°ÙƒÙŠØ© ÙˆØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ ---
    db.on('value', (s) => {
        const d = s.val();
        if (!d) return;

        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù€ timestamp Ù‚Ø¯ÙŠÙ… Ø£Ùˆ Ù…ÙƒØ±Ø± (ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚)
        if (d.timestamp && d.timestamp < lastTimestamp) return;
        lastTimestamp = d.timestamp;

        isRemoteUpdate = true;
        
        if (player.src !== d.url) loadVideo(d.url);
        
        // Ø§Ù„Ù‚ÙØ² Ù„Ù„ÙˆÙ‚Øª Ø§Ù„ØµØ­ÙŠØ­ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ§Ø±Ù‚ Ø£ÙƒØ¨Ø± Ù…Ù† Ø«Ø§Ù†ÙŠØªÙŠÙ†
        const timeDiff = Math.abs(player.currentTime - d.time);
        if (timeDiff > 2.5) { 
            player.currentTime = d.time; 
        }
        
        if (d.status === "play") {
            player.play().catch(() => {
                statusDiv.innerText = "Ø§Ù„Ø¨Ø« ÙŠØ¹Ù…Ù„ ØµØ§Ù…ØªØ§Ù‹.. Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØª ğŸ”Š";
            });
        } else if (d.status === "pause") {
            player.pause();
        }
        
        setTimeout(() => { isRemoteUpdate = false; }, 1200);
    });

    viewersRef.on('value', (s) => document.getElementById('viewerCount').innerText = s.numChildren() || 0);

    // Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙŠØ­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    player.onplay = () => { if(isAdmin && !isRemoteUpdate) db.update({status:"play", time:player.currentTime, timestamp: Date.now()}); };
    player.onpause = () => { if(isAdmin && !isRemoteUpdate) db.update({status:"pause", time:player.currentTime, timestamp: Date.now()}); };
    
    setInterval(() => { 
        if(isAdmin && !player.paused && !isRemoteUpdate) {
            db.update({time:player.currentTime, timestamp: Date.now()}); 
        }
    }, 4000);

</script>
</body>
</html>
