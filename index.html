<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± - Ù†Ø¸Ø§Ù… Ø§ØªØµØ§Ù„</title>
    <style>
        :root { --primary: #007AFF; --bg: #000000; --card: #1C1C1E; --accent: #32D74B; --danger: #FF3B30; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); color: white; margin: 0; padding: 0;
            display: flex; flex-direction: column; min-height: 100vh; overflow-y: auto;
        }
        .header { padding: 15px; text-align: center; background: var(--card); border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
        .content { padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        .video-container {
            position: relative; width: 100%; background: #000; border-radius: 15px; overflow: hidden;
            aspect-ratio: 16 / 9; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .call-box {
            background: linear-gradient(145deg, #1c1c1e, #2c2c2e);
            padding: 15px; border-radius: 15px; border: 1px solid #444;
            display: flex; flex-direction: column; gap: 10px; align-items: center;
        }
        .call-status { font-size: 14px; color: var(--accent); font-weight: bold; }
        .call-btn {
            width: 100%; padding: 12px; border-radius: 12px; border: none;
            font-weight: bold; font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.3s; color: white;
        }
        .btn-join { background: var(--primary); }
        .btn-leave { background: var(--danger); }

        /* Ø§Ù„Ø´Ø§Øª */
        .chat-container { background: var(--card); border-radius: 15px; display: flex; flex-direction: column; height: 250px; }
        #chatMessages { flex: 1; overflow-y: auto; padding: 10px; font-size: 14px; display: flex; flex-direction: column; gap: 8px; }
        .msg { background: #2C2C2E; padding: 8px 12px; border-radius: 12px; width: fit-content; max-width: 80%; }
        .msg-admin { border-right: 3px solid var(--primary); background: #1a2a3a; }
        .chat-input-area { display: flex; padding: 10px; gap: 8px; border-top: 1px solid #333; }
        .chat-input-area input { flex: 1; background: #111; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; }

        /* Ø§Ù„ØªØ­ÙƒÙ… */
        .controls-card { background: var(--card); padding: 15px; border-radius: 15px; display: flex; flex-direction: column; gap: 12px; }
        #adminPanel { display: none; border: 1px solid var(--primary); }
        input { background: #2C2C2E; border: 1px solid #3d3d3d; padding: 12px; border-radius: 10px; color: white; outline: none; }
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .viewer-badge { display: inline-block; background: var(--danger); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; align-self: center; }
    </style>
</head>
<body>

<div class="header"><h3 style="margin:0;">Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ù…ØªØ²Ø§Ù…Ù† ğŸ¬</h3></div>

<div class="content">
    <div class="viewer-badge">â— Ù…Ø¨Ø§Ø´Ø±: <span id="viewerCount">0</span></div>

    <div class="video-container">
        <video id="livePlayer" controls playsinline webkit-playsinline></video>
    </div>

    <div class="call-box">
        <div class="call-status" id="callStatus">ğŸ“ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù…ØºÙ„Ù‚Ø©</div>
        <button id="callBtn" class="call-btn btn-join" onclick="handleCall()">ğŸ“± ÙØªØ­ Ø®Ø· (Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø©)</button>
    </div>

    <div class="chat-container">
        <div id="chatMessages"></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
            <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <div class="controls-card" id="loginPanel">
        <input type="password" id="passInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±...">
        <button onclick="checkPassword()">Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„</button>
    </div>

    <div id="adminPanel" class="controls-card">
        <div style="color:var(--accent); font-size:12px;">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (8998) ğŸ”’</div>
        <input type="url" id="urlInput" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯...">
        <button onclick="updateGlobalVideo()">ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAjTD-OJBUYewp5bqV0iVh4Rxp5zjBsU54",
        authDomain: "videos-5e336.firebaseapp.com",
        databaseURL: "https://videos-5e336-default-rtdb.firebaseio.com",
        projectId: "videos-5e336",
        storageBucket: "videos-5e336.firebasestorage.app",
        messagingSenderId: "300218651134",
        appId: "1:300218651134:web:4bd24df8e555e62828f0af"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('live_sync');
    const chatRef = firebase.database().ref('chat');
    const viewersRef = firebase.database().ref('viewers_presence');
    const player = document.getElementById('livePlayer');
    
    let isAdmin = false;
    let isRemoteUpdate = false;
    let localStream;
    let peer;
    let isConnected = false;

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø§ØªØµØ§Ù„ (PeerJS) ---
    peer = new Peer(); 

    function handleCall() {
        if (!isConnected) {
            startCall();
        } else {
            stopCall();
        }
    }

    async function startCall() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            isConnected = true;
            document.getElementById('callBtn').innerText = "ğŸ“´ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©";
            document.getElementById('callBtn').className = "call-btn btn-leave";
            document.getElementById('callStatus').innerText = "ğŸ™ï¸ Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ø®Ø·..";
            
            // ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ ÙŠØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø£ÙŠ Ø´Ø®Øµ ÙŠØ¯Ø®Ù„
            peer.on('call', (call) => {
                call.answer(localStream);
                const audio = new Audio();
                call.on('stream', (remoteStream) => {
                    audio.srcObject = remoteStream;
                    audio.play();
                });
            });
        } catch (e) {
            alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„Ø§ØªØµØ§Ù„");
        }
    }

    function stopCall() {
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        isConnected = false;
        document.getElementById('callBtn').innerText = "ğŸ“± ÙØªØ­ Ø®Ø· (Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø©)";
        document.getElementById('callBtn').className = "call-btn btn-join";
        document.getElementById('callStatus').innerText = "ğŸ“ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù…ØºÙ„Ù‚Ø©";
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± 8998) ---
    function checkPassword() {
        if(document.getElementById('passInput').value === "8998") {
            isAdmin = true;
            document.getElementById('loginPanel').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'flex';
        } else { alert("Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±!"); }
    }

    // Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
    player.onseeking = () => {
        if (!isAdmin && !isRemoteUpdate) {
            db.child('time').once('value', (s) => { player.currentTime = s.val(); });
        }
    };

    function sendMessage() {
        const text = document.getElementById('chatInput').value;
        if(text) {
            chatRef.push({ text, admin: isAdmin });
            document.getElementById('chatInput').value = '';
        }
    }

    chatRef.limitToLast(10).on('child_added', (s) => {
        const m = s.val();
        const div = document.createElement('div');
        div.className = `msg ${m.admin ? 'msg-admin' : ''}`;
        div.innerText = (m.admin ? "â­ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: " : "ğŸ‘¤: ") + m.text;
        document.getElementById('chatMessages').appendChild(div);
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    });

    // Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    const myPresenceRef = viewersRef.push(true);
    myPresenceRef.onDisconnect().remove();
    viewersRef.on('value', s => { document.getElementById('viewerCount').innerText = s.numChildren(); });

    db.on('value', (snapshot) => {
        const data = snapshot.val();
        if (!data || isAdmin) return; 
        isRemoteUpdate = true;
        if (player.src !== data.url) player.src = data.url;
        if (Math.abs(player.currentTime - data.time) > 2) player.currentTime = data.time;
        data.status === "play" ? player.play().catch(()=> {}) : player.pause();
        setTimeout(() => isRemoteUpdate = false, 500);
    });

    function updateGlobalVideo() {
        const url = document.getElementById('urlInput').value;
        if(url && isAdmin) db.set({ url, status: "play", time: 0 });
    }

    setInterval(() => { if(isAdmin && !player.paused) db.update({ time: player.currentTime, status: "play" }); }, 3000);
</script>
</body>
</html>
